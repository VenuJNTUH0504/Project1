<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Language Code Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #ffffff;
            --text-primary: #2c3e50;
            --card-bg: rgba(255, 255, 255, 0.95);
            --accent: #3498db;
            --border-color: #e2e8f0;
            --success: #28a745;
            --error: #dc3545;
            --gradient: linear-gradient(135deg, #6366f1, #3b82f6);
        }

        .dark-theme {
            --bg-primary: #1a1a2e;
            --text-primary: #ffffff;
            --card-bg: rgba(26, 26, 46, 0.95);
            --accent: #4a90e2;
            --border-color: #3c3c3c;
            --gradient: linear-gradient(135deg, #4a90e2, #67b26f);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: var(--gradient);
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 30px;
            background: var(--gradient);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 1000;
            border: none;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            animation: fadeDown 0.5s ease;
        }

        .language-selector {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid var(--accent);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .editor-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background: var(--gradient);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .control-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .main-content {
            display: flex;
            gap: 20px;
            height: calc(100vh - 100px);
        }

        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #editor {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .output-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .output-container {
            flex: 1;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            overflow: auto;
            border: 1px solid var(--border-color);
            font-family: 'Consolas', monospace;
            display: flex;
            flex-direction: column;
        }

        .output-status {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
        }
        
        .status-success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .status-error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .status-running {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .clear-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clear-btn:hover {
            background-color: #2980b9;
        }

        .stdin-container {
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .stdin-container details summary {
            cursor: pointer;
            color: var(--accent);
            font-weight: 500;
            padding: 5px 0;
        }

        .stdin-container textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: 'Consolas', monospace;
            background: var(--card-bg);
            color: var(--text-primary);
            resize: vertical;
            margin-top: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-item i {
            color: var(--accent);
        }

        .success-message {
            color: var(--success);
        }

        .error-message {
            color: var(--error);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .output-title {
            font-weight: bold;
            color: var(--accent);
        }

        .execution-info {
            font-size: 12px;
            color: #888;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .editor-section, .output-section {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
        <span>Back</span>
    </button>
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <div class="editor-container">
        <div class="header" style="text-align: center; padding: 20px 0; animation: fadeDown 0.5s ease;">
            <h1 style="font-size: 2.5em; margin-bottom: 10px; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Multi-Language Code Editor</h1>
            <p style="color: var(--text-primary); opacity: 0.8;">Write, Run, and Debug code in 15+ programming languages</p>
        </div>
        
        <div class="editor-header">
            <select class="language-selector" id="languageSelect">
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="javascript">JavaScript</option>
                <option value="typescript">TypeScript</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="csharp">C#</option>
                <option value="go">Go</option>
                <option value="ruby">Ruby</option>
                <option value="swift">Swift</option>
                <option value="php">PHP</option>
                <option value="kotlin">Kotlin</option>
                <option value="perl">Perl</option>
                <option value="r">R</option>
            </select>
            <div class="editor-controls">
                <button class="control-btn" id="runBtn">
                    <i class="fas fa-play"></i> Run
                </button>
                <button class="control-btn" id="formatBtn">
                    <i class="fas fa-code"></i> Format
                </button>
                <button class="control-btn" id="clearBtn">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button class="control-btn" id="saveBtn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="editor-section">
                <div id="editor"></div>
            </div>
            <div class="output-section">
                <div class="output-container" id="output">
                    <div class="output-header">
                        <span class="output-title">Output</span>
                        <button class="clear-btn" onclick="clearOutput()">Clear</button>
                    </div>
                    <div id="execution-status" class="output-status" style="display: none;"></div>
                    <div id="outputContent">Click "Run" to execute your code...</div>
                    <div id="execution-stats" style="margin-top: 10px; font-size: 0.85rem; color: #666;"></div>
                    
                    <div class="stdin-container">
                        <details>
                            <summary>Program Input (stdin)</summary>
                            <textarea id="userInput" placeholder="Enter input for your program here..."></textarea>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language mapping for Piston API and Monaco Editor
        const languageConfig = {
            'html': { 
                pistonLang: null, 
                monacoLang: 'html', 
                extension: 'html',
                template: '<!DOCTYPE html>\n<html>\n<head>\n    <title>My Page</title>\n</head>\n<body>\n    <h1>Hello World!</h1>\n</body>\n</html>'
            },
            'css': { 
                pistonLang: null, 
                monacoLang: 'css', 
                extension: 'css',
                template: 'body {\n    font-family: Arial, sans-serif;\n    background-color: #f0f0f0;\n    margin: 0;\n    padding: 20px;\n}\n\nh1 {\n    color: #333;\n    text-align: center;\n}'
            },
            'javascript': { 
                pistonLang: 'javascript', 
                monacoLang: 'javascript', 
                extension: 'js',
                template: 'console.log("Hello, World!");\n\n// Your JavaScript code here\nfunction greet(name) {\n    return `Hello, ${name}!`;\n}\n\nconsole.log(greet("JavaScript"));'
            },
            'typescript': { 
                pistonLang: 'typescript', 
                monacoLang: 'typescript', 
                extension: 'ts',
                template: 'console.log("Hello, TypeScript!");\n\n// Your TypeScript code here\nfunction greet(name: string): string {\n    return `Hello, ${name}!`;\n}\n\nconsole.log(greet("TypeScript"));'
            },
            'python': { 
                pistonLang: 'python', 
                monacoLang: 'python', 
                extension: 'py',
                template: 'print("Hello, World!")\n\n# Your Python code here\ndef greet(name):\n    return f"Hello, {name}!"\n\nprint(greet("Python"))'
            },
            'java': { 
                pistonLang: 'java', 
                monacoLang: 'java', 
                extension: 'java',
                template: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n        \n        // Your Java code here\n        String name = "Java";\n        System.out.println("Hello, " + name + "!");\n    }\n}'
            },
            'cpp': { 
                pistonLang: 'cpp', 
                monacoLang: 'cpp', 
                extension: 'cpp',
                template: '#include <iostream>\n#include <string>\n\nint main() {\n    std::cout << "Hello, World!" << std::endl;\n    \n    // Your C++ code here\n    std::string name = "C++";\n    std::cout << "Hello, " << name << "!" << std::endl;\n    \n    return 0;\n}'
            },
            'csharp': { 
                pistonLang: 'csharp', 
                monacoLang: 'csharp', 
                extension: 'cs',
                template: 'using System;\n\nclass Program\n{\n    static void Main()\n    {\n        Console.WriteLine("Hello, World!");\n        \n        // Your C# code here\n        string name = "C#";\n        Console.WriteLine($"Hello, {name}!");\n    }\n}'
            },
            'go': { 
                pistonLang: 'go', 
                monacoLang: 'go', 
                extension: 'go',
                template: 'package main\n\nimport "fmt"\n\nfunc main() {\n    fmt.Println("Hello, World!")\n    \n    // Your Go code here\n    name := "Go"\n    fmt.Printf("Hello, %s!\\n", name)\n}'
            },
            'ruby': { 
                pistonLang: 'ruby', 
                monacoLang: 'ruby', 
                extension: 'rb',
                template: 'puts "Hello, World!"\n\n# Your Ruby code here\ndef greet(name)\n  "Hello, #{name}!"\nend\n\nputs greet("Ruby")'
            },
            'swift': { 
                pistonLang: 'swift', 
                monacoLang: 'swift', 
                extension: 'swift',
                template: 'print("Hello, World!")\n\n// Your Swift code here\nfunc greet(name: String) -> String {\n    return "Hello, \\(name)!"\n}\n\nprint(greet(name: "Swift"))'
            },
            'php': { 
                pistonLang: 'php', 
                monacoLang: 'php', 
                extension: 'php',
                template: '<?php\necho "Hello, World!\\n";\n\n// Your PHP code here\nfunction greet($name) {\n    return "Hello, " . $name . "!";\n}\n\necho greet("PHP") . "\\n";\n?>'
            },
            'kotlin': { 
                pistonLang: 'kotlin', 
                monacoLang: 'kotlin', 
                extension: 'kt',
                template: 'fun main() {\n    println("Hello, World!")\n    \n    // Your Kotlin code here\n    val name = "Kotlin"\n    println("Hello, $name!")\n}'
            },
            'perl': { 
                pistonLang: 'perl', 
                monacoLang: 'perl', 
                extension: 'pl',
                template: 'print "Hello, World!\\n";\n\n# Your Perl code here\nsub greet {\n    my $name = shift;\n    return "Hello, $name!";\n}\n\nprint greet("Perl") . "\\n";'
            },
            'r': { 
                pistonLang: 'r', 
                monacoLang: 'r', 
                extension: 'r',
                template: 'print("Hello, World!")\n\n# Your R code here\ngreet <- function(name) {\n  paste("Hello,", name, "!")\n}\n\nprint(greet("R"))'
            }
        };

        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            const themeIcon = document.getElementById('themeIcon');
            
            // Update theme icon
            themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            // Update editor theme if initialized
            if (window.editor) {
                window.editor.updateOptions({
                    theme: isDark ? 'vs-dark' : 'vs-light'
                });
            }
            
            // Save theme preference
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeIcon').className = 'fas fa-sun';
            }
        }

        // Back button functionality
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '../index.html';
            }
        }

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Check theme on initialization
            const isDark = document.body.classList.contains('dark-theme');
            
            window.editor = monaco.editor.create(document.getElementById('editor'), {
                value: languageConfig['javascript'].template,
                language: 'javascript',
                theme: isDark ? 'vs-dark' : 'vs-light',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                readOnly: false,
                cursorStyle: 'line',
                tabSize: 4,
                wordWrap: 'on'
            });

            // Language selection handler
            document.getElementById('languageSelect').addEventListener('change', function(e) {
                const language = e.target.value;
                const config = languageConfig[language];
                
                if (window.editor) {
                    try {
                        monaco.editor.setModelLanguage(window.editor.getModel(), config.monacoLang);
                        window.editor.setValue(config.template);
                    } catch (error) {
                        console.error('Error setting language:', error);
                        monaco.editor.setModelLanguage(window.editor.getModel(), 'plaintext');
                        
                        const statusElement = document.getElementById('execution-status');
                        statusElement.style.display = 'block';
                        statusElement.className = 'output-status status-error';
                        statusElement.textContent = 'Language Warning';
                        
                        document.getElementById('outputContent').textContent = `Warning: The language "${language}" might not be fully supported. Basic editing is available.`;
                        
                        setTimeout(() => {
                            clearOutput();
                        }, 3000);
                    }
                }
                
                document.getElementById('languageStatus').textContent = `Language: ${language.charAt(0).toUpperCase() + language.slice(1)}`;
                
                // Clear output
                clearOutput();
            });

            // Show loading state
            function showLoading() {
                const outputContent = document.getElementById('outputContent');
                const statusElement = document.getElementById('execution-status');
                const statsElement = document.getElementById('execution-stats');
                
                outputContent.innerHTML = '<div class="loading-spinner"></div> Compiling and executing your code...';
                
                statusElement.style.display = 'block';
                statusElement.className = 'output-status status-running';
                statusElement.textContent = 'Running...';
                
                statsElement.textContent = '';
            }

            // Clear output function
            function clearOutput() {
                const outputContent = document.getElementById('outputContent');
                const statusElement = document.getElementById('execution-status');
                const statsElement = document.getElementById('execution-stats');
                
                outputContent.textContent = 'Click "Run" to execute your code...';
                statusElement.style.display = 'none';
                statsElement.textContent = '';
            }

            // Format code function
            function formatCode() {
                if (window.editor) {
                    try {
                        window.editor.getAction('editor.action.formatDocument').run();
                    } catch (error) {
                        console.error('Error formatting code:', error);
                        const outputContent = document.getElementById('outputContent');
                        const statusElement = document.getElementById('execution-status');
                        
                        statusElement.style.display = 'block';
                        statusElement.className = 'output-status status-error';
                        statusElement.textContent = 'Format Error';
                        
                        outputContent.textContent = 'Code formatting is not available for this language.';
                        
                        setTimeout(() => {
                            clearOutput();
                        }, 3000);
                    }
                }
            }

            // Sanitize output function
            function sanitizeOutput(text) {
                if (!text) return '';
                
                if (typeof text !== 'string') {
                    try {
                        text = JSON.stringify(text);
                    } catch (e) {
                        text = String(text);
                    }
                }
                
                const maxLength = 10000;
                if (text.length > maxLength) {
                    text = text.substring(0, maxLength) + '... (output truncated)';
                }
                
                return text;
            }

            // Run button handler
            document.getElementById('runBtn').addEventListener('click', async function() {
                const code = window.editor.getValue();
                const language = document.getElementById('languageSelect').value;
                const userInput = document.getElementById('userInput').value;
                const outputContent = document.getElementById('outputContent');
                const statusElement = document.getElementById('execution-status');
                const statsElement = document.getElementById('execution-stats');
                const config = languageConfig[language];
                
                if (!code.trim()) {
                    statusElement.style.display = 'block';
                    statusElement.className = 'output-status status-error';
                    statusElement.textContent = 'Error: Empty Code';
                    outputContent.textContent = 'Please enter some code before running.';
                    return;
                }

                showLoading();
                
                try {
                    const startTime = performance.now();
                    
                    if (['html', 'css'].includes(language)) {
                        // Frontend execution for HTML/CSS
                        if (language === 'html') {
                            // Create a safe iframe for HTML execution
                            const iframe = document.createElement('iframe');
                            iframe.style.width = '100%';
                            iframe.style.height = '300px';
                            iframe.style.border = '1px solid var(--border-color)';
                            iframe.style.borderRadius = '4px';
                            outputContent.innerHTML = '';
                            outputContent.appendChild(iframe);
                            
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            iframeDoc.open();
                            iframeDoc.write(code);
                            iframeDoc.close();
                        } else if (language === 'css') {
                            // Create a demo HTML with the CSS applied
                            const demoHTML = `
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <style>${code}</style>
                                </head>
                                <body>
                                    <h1>CSS Demo</h1>
                                    <p>This is a paragraph to demonstrate your CSS.</p>
                                    <div class="demo-box">Demo Box</div>
                                    <button>Demo Button</button>
                                </body>
                                </html>
                            `;
                            
                            const iframe = document.createElement('iframe');
                            iframe.style.width = '100%';
                            iframe.style.height = '300px';
                            iframe.style.border = '1px solid var(--border-color)';
                            iframe.style.borderRadius = '4px';
                            outputContent.innerHTML = '';
                            outputContent.appendChild(iframe);
                            
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            iframeDoc.open();
                            iframeDoc.write(demoHTML);
                            iframeDoc.close();
                        }
                        
                        const endTime = performance.now();
                        statusElement.style.display = 'block';
                        statusElement.className = 'output-status status-success';
                        statusElement.textContent = 'Rendered Successfully';
                        statsElement.textContent = `Rendered in ${(endTime - startTime).toFixed(2)}ms`;
                        
                    } else if (language === 'javascript') {
                        // Client-side JavaScript execution
                        let output = '';
                        const originalLog = console.log;
                        const originalError = console.error;
                        
                        // Capture console output
                        console.log = (...args) => {
                            output += args.map(arg => 
                                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                            ).join(' ') + '\\n';
                        };
                        
                        console.error = (...args) => {
                            output += 'ERROR: ' + args.map(arg => 
                                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                            ).join(' ') + '\\n';
                        };
                        
                        try {
                            // Execute the code
                            const result = eval(code);
                            if (result !== undefined && !output.includes(String(result))) {
                                output += String(result) + '\\n';
                            }
                            
                            outputContent.innerHTML = `<pre>${output || 'Code executed successfully (no output)'}</pre>`;
                        } catch (error) {
                            outputContent.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                        } finally {
                            // Restore original console methods
                            console.log = originalLog;
                            console.error = originalError;
                        }
                        
                        const endTime = performance.now();
                        statusElement.style.display = 'block';
                        statusElement.className = 'output-status status-success';
                        statusElement.textContent = 'Execution Successful';
                        statsElement.textContent = `Executed in ${(endTime - startTime).toFixed(2)}ms`;
                        
                    } else {
                        // Backend execution using Piston API
                        const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                language: config.pistonLang,
                                version: '*',
                                files: [{
                                    name: `main.${config.extension}`,
                                    content: code
                                }],
                                stdin: userInput || '',
                                compile_timeout: 10000,
                                run_timeout: 3000,
                                compile_memory_limit: -1,
                                run_memory_limit: -1
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        const endTime = performance.now();
                        
                        let output = '';
                        let hasError = false;
                        
                        // Handle compilation errors
                        if (result.compile && result.compile.stderr) {
                            output += `<div class="error-message">Compilation Error:\\n${result.compile.stderr}</div>`;
                            hasError = true;
                        }
                        
                        // Handle runtime output and errors
                        if (result.run) {
                            if (result.run.stdout) {
                                output += `<pre>${result.run.stdout}</pre>`;
                            }
                            if (result.run.stderr) {
                                output += `<div class="error-message">Runtime Error:\\n${result.run.stderr}</div>`;
                                hasError = true;
                            }
                            if (!result.run.stdout && !result.run.stderr) {
                                output += '<div>Program executed successfully (no output)</div>';
                            }
                        } else if (!hasError) {
                            output += '<div class="error-message">Execution failed - no result returned</div>';
                        }
                        
                        outputContent.innerHTML = output;
                        
                        // Show execution info
                        let infoText = `Executed in ${(endTime - startTime).toFixed(2)}ms`;
                        let statusClass = 'status-success';
                        let statusText = 'Execution Successful';
                        
                        if (result.run && result.run.code !== undefined && result.run.code !== 0) {
                            infoText += ` | Exit code: ${result.run.code}`;
                            statusClass = 'status-error';
                            statusText = 'Execution Failed';
                        }
                        
                        if (result.compile && result.compile.stderr) {
                            statusClass = 'status-error';
                            statusText = 'Compilation Error';
                        }
                        
                        if (result.run && result.run.stderr && !result.run.stdout) {
                            statusClass = 'status-error';
                            statusText = 'Runtime Error';
                        }
                        
                        statusElement.style.display = 'block';
                        statusElement.className = `output-status ${statusClass}`;
                        statusElement.textContent = statusText;
                        statsElement.textContent = infoText;
                    }
                    
                    // Update status bar
                    document.getElementById('executionTime').textContent = 
                        `Execution Time: ${(performance.now() - startTime).toFixed(2)}ms`;
                    
                } catch (error) {
                    statusElement.style.display = 'block';
                    statusElement.className = 'output-status status-error';
                    statusElement.textContent = 'Connection Error';
                    
                    const errorMessage = `Failed to execute code: ${error.message || 'Unknown error'}`;
                    outputContent.innerHTML = `<div class="error-message">${sanitizeOutput(errorMessage)}</div>`;
                    outputContent.innerHTML += '<div style="margin-top: 10px; font-size: 0.9em; color: #666;">Troubleshooting:<br>- Make sure you have an internet connection<br>- Try again in a few moments</div>';
                    
                    console.error('Execution error:', error);
                }
            });

            // Format button handler
            document.getElementById('formatBtn').addEventListener('click', formatCode);

            // Clear button handler
            document.getElementById('clearBtn').addEventListener('click', function() {
                const language = document.getElementById('languageSelect').value;
                const config = languageConfig[language];
                window.editor.setValue(config.template);
                clearOutput();
                document.getElementById('userInput').value = '';
                document.getElementById('executionTime').textContent = 'Execution Time: 0ms';
            });

            // Save button handler
            document.getElementById('saveBtn').addEventListener('click', function() {
                const code = window.editor.getValue();
                const language = document.getElementById('languageSelect').value;
                const config = languageConfig[language];
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `code.${config.extension}`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.editor) {
                    window.editor.layout();
                }
            });

            // Initialize with JavaScript template
            document.getElementById('languageStatus').textContent = 'Language: JavaScript';
        });

        // Load theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
        });
    </script>
</body>
</html>